# RetinaFace


This implements training of RetinaFace on the Wider Face dataset, mainly modified from [modelzoo: Ascend Model Zoo - Gitee.com](https://gitee.com/ascend/modelzoo/tree/master/contrib/PyTorch/Research/cv/image_object_detection/Pytorch_Retinaface).

## Retinaface Detail

Base version of the model from [retinaface.py](https://github.com/biubug6/Pytorch_Retinaface.git)
As of the current date, Ascend-Pytorch is still inefficient for contiguous operations. 
Therefore, RetinaFace is re-implemented using semantics such as custom OP.

## Requirements

- Install PyTorch ([pytorch.org](http://pytorch.org))
- Install IPython (pip3 install IPython)
- git clone https://gitee.com/ascend/modelzoo.git
- Download the Wider Face dataset from [Wider Face](http://shuoyang1213.me/WIDERFACE/)
- Download annotations (face bounding boxes & five facial landmarks) from [baidu cloud](https://pan.baidu.com/s/1Laby0EctfuJGgGMgRRgykA) or [dropbox](https://www.dropbox.com/s/7j70r3eeepe4r2g/retinaface_gt_v1.1.zip?dl=0)

## Before evaluating and training

- make sure that there are wider_face_val.mat`, `wider_easy_val.mat`, `wider_medium_val.mat`,`wider_hard_val.mat` in path $PROJECT_ROOT/widerface_evaluate/groud_truth" if you donot have them,please download them from https://github.com/biubug6/Pytorch_Retinaface.git.Once you have downloaded,please copy the groud_truth directory from widerface_evaluate/groud_truth to $Project_Root/widerface_evaluate/groud_truth.
- make sure that there is widerface_txt in retinaface/widerface_evaluate
- Download annotations(label.txt) (face bounding boxes & five facial landmarks) from [baidu cloud](https://pan.baidu.com/s/1Laby0EctfuJGgGMgRRgykA) or [dropbox](https://www.dropbox.com/s/7j70r3eeepe4r2g/retinaface_gt_v1.1.zip?dl=0)
- Organise the dataset directory as follows:

```Shell
  ./data/widerface/
    train/
      images/
      label.txt
    val/
      images/
      wider_val.txt
      label.txt
```
ps: wider_val.txt is generated by tools.py.Run it after you put the label.txt in path.
```
python3.7 tools.py
```
## Training 

To train a model, run `train.py` with the desired model architecture and the path to the Wider Face dataset:

Firstly,prepare the dataset,xxx/widerface means the path where the WiderFace locates
```
ln -s xxx/widerface/train/images data/widerface/train/
ln -s xxx/widerface/val/images data/widerface/val/
```
        
```bash
# train
bash test/train_xx_xp.sh --data_path=The path to dataset 

# eval
bash test/train_eval_8p.sh

# online inference demo 
python3.7.5 demo.py 
# To ONNX
python3.7.5 pthtar2onnx.py
```

## RetinaFace training result

| Event    | FPS       | Npu_nums| Epochs   | Type     | AP       |
| :------: | :------:  | :------ | :------: | :------: | :------: |
| Easy     | 32.519    | 8       | 100       | O2       | 94.37     |
| Medium   | 32.519    | 8       | 100       | O2       | 93.14    |      
| Hard     | 32.519    | 8       | 100       | O2       | 86.7     |

